<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mysql 慢日志分析平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
        }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }

        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
        }

        .list-group-item i {
            margin-right: 10px;
        }

        .chart-container {
            height: 250px;
            margin-bottom: 20px;
        }

        .badge {
            font-size: 0.9em;
        }

        .clickable-fingerprint {
            cursor: pointer;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        #queriesTable {
            font-size: 0.85rem;
            width: 100% !important;
        }

        .stats-item {
            font-size: 0.9rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        #dbFilter {
            margin-bottom: 15px;
        }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 其他现有的脚本引用 -->
</head>

<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">Mysql 慢日志分析平台</h1>

        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <div class="input-group">
                    <input type="file" id="logFile" class="form-control">
                    <button id="uploadBtn" class="btn btn-primary">上传并分析</button>
                </div>
            </div>
        </div>

        <!-- 历史记录下拉菜单 -->
        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <select id="historySelect" class="form-select">
                    <option value="">选择历史分析记录</option>
                </select>
            </div>
        </div>

        <div id="results">
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">查询性能概览</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="metric">
                                        <h6>平均查询时间</h6>
                                        <span id="avgQueryTime"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <h6>95%查询时间</h6>
                                        <span id="95pctQueryTime"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <h6>最长查询间</h6>
                                        <span id="maxQueryTime"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <h6>总查询次数</h6>
                                        <span id="totalQueryCount"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">查询时间分布</h5>
                            <div class="chart-container">
                                <canvas id="queryTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">查询次数分布</h5>
                            <div class="chart-container">
                                <canvas id="queryCountChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">资源消耗 - 检查的行数</h5>
                            <div class="chart-container">
                                <canvas id="rowsExaminedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">资源消耗 - 返回的行数</h5>
                            <div class="chart-container">
                                <canvas id="rowsSentChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">数据库使用情况</h5>
                            <div class="chart-container">
                                <canvas id="dbUsageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">表使用情况</h5>
                            <div class="chart-container">
                                <canvas id="tableUsageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">查询时间趋势</h5>
                            <div class="chart-container">
                                <canvas id="queryTimeTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">锁等待时间</h5>
                            <div class="chart-container">
                                <canvas id="lockWaitTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">所有查询</h5>
                            <div id="dbFilter" class="mb-3">
                                <label for="dbSelect" class="form-label">选择数据库：</label>
                                <select id="dbSelect" class="form-select">
                                    <option value="">所有数据库</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <div id="allQueries"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal fade" id="sqlModal" tabindex="-1" aria-labelledby="sqlModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sqlModalLabel">完整 SQL 查询</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre><code class="sql" id="modalSqlContent"></code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本引用 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql-formatter/4.0.2/sql-formatter.min.js"></script>

    <script>
        $(document).ready(function () {
            let queriesTable;
            let chartInstances = {};

            function visualizeData(data) {
                try {
                    updatePerformanceOverview(data.global);
                    createQueryTimeChart(data.classes);
                    createQueryCountChart(data.classes);
                    createResourceConsumptionCharts(data.classes);
                    createDatabaseAndTableUsageCharts(data.classes);
                    if (data.classes && data.classes.length > 0) {
                        createQueryTimeTrendChart(data.classes);
                    } else {
                        console.warn("No valid data for query time trend chart");
                    }
                    createLockWaitTimeChart(data.classes);
                    displayAllQueries(data.classes);
                } catch (error) {
                    console.error("Error in visualizeData:", error);
                    $('#results').html('<p class="text-danger">可视化数据时发生错误: ' + error.message + '</p>');
                }
            }

            function updatePerformanceOverview(globalData) {
                $('#avgQueryTime').text(parseFloat(globalData.metrics.Query_time.avg).toFixed(4) + ' 秒');
                $('#95pctQueryTime').text(parseFloat(globalData.metrics.Query_time.pct_95).toFixed(4) + ' 秒');
                $('#maxQueryTime').text(parseFloat(globalData.metrics.Query_time.max).toFixed(4) + ' 秒');
                $('#totalQueryCount').text(globalData.query_count);
            }

            function createQueryTimeChart(classes) {
                var ctx = document.getElementById('queryTimeChart').getContext('2d');
                var data = classes.slice(0, 10).map(c => ({
                    fingerprint: truncateString(c.fingerprint, 30),
                    fullFingerprint: c.fingerprint,
                    avgTime: parseFloat(c.metrics.Query_time.avg),
                    fullSql: c.example.query
                }));

                if (chartInstances.queryTimeChart) {
                    chartInstances.queryTimeChart.destroy();
                }

                chartInstances.queryTimeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.fingerprint),
                        datasets: [{
                            label: '平均查询时间（秒）',
                            data: data.map(d => d.avgTime),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '前10个最慢查询的平均执行时间'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return data[tooltipItems[0].dataIndex].fullFingerprint;
                                    },
                                    afterBody: function (tooltipItems) {
                                        return 'SQL: ' + decodeChineseCharacters(data[tooltipItems[0].dataIndex].fullSql);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                showFormattedSql(data[index].fullSql);
                            }
                        }
                    }
                });


            }

            function showQueryDetails(data) {
                var detailsHtml = '<div class="table-responsive"><table class="table table-striped">';
                detailsHtml += '<thead><tr><th>查询指纹</th><th>平均时间(秒)</th><th>SQL</th></tr></thead><tbody>';

                data.forEach(d => {
                    detailsHtml += `<tr>
                        <td>${d.fullFingerprint}</td>
                        <td>${d.avgTime.toFixed(4)}</td>
                        <td><button class="btn btn-sm btn-primary view-sql" data-sql="${encodeURIComponent(d.fullSql)}">查看SQL</button></td>
                    </tr>`;
                });

                detailsHtml += '</tbody></table></div>';

                $('#modalSqlContent').html(detailsHtml);
                var modal = new bootstrap.Modal(document.getElementById('sqlModal'));
                modal.show();

                // 为"查看SQL"按钮添加事件监听器
                $('.view-sql').on('click', function () {
                    showFormattedSql($(this).data('sql'));
                });
            }

            function createQueryCountChart(classes) {
                var ctx = document.getElementById('queryCountChart').getContext('2d');
                var data = classes.slice(0, 5).map(c => ({
                    fingerprint: truncateString(c.fingerprint, 30),
                    fullFingerprint: c.fingerprint,
                    queryCount: c.query_count,
                    fullSql: c.example.query
                }));

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(d => d.fingerprint),
                        datasets: [{
                            data: data.map(d => d.queryCount),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '前5个查询的执行次数'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return data[tooltipItems[0].dataIndex].fullFingerprint;
                                    },
                                    afterBody: function (tooltipItems) {
                                        return 'SQL: ' + decodeChineseCharacters(data[tooltipItems[0].dataIndex].fullSql);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                showFormattedSql(data[index].fullSql);
                            }
                        }
                    }
                });
            }

            function createResourceConsumptionCharts(classes) {
                createRowsExaminedChart(classes);
                createRowsSentChart(classes);
            }

            function createRowsExaminedChart(classes) {
                var ctx = document.getElementById('rowsExaminedChart').getContext('2d');
                var data = classes.slice(0, 10).map(c => ({
                    fingerprint: truncateString(decodeChineseCharacters(c.fingerprint), 30),
                    fullFingerprint: c.fingerprint,
                    avgRowsExamined: parseFloat(c.metrics.Rows_examined.avg),
                    fullSql: c.example.query
                }));

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.fingerprint),
                        datasets: [{
                            label: '平均检查行数',
                            data: data.map(d => d.avgRowsExamined),
                            backgroundColor: 'rgba(255, 159, 64, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '前10个查询的平均检查行数'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return data[tooltipItems[0].dataIndex].fullFingerprint;
                                    },
                                    afterBody: function (tooltipItems) {
                                        return 'SQL: ' + decodeChineseCharacters(data[tooltipItems[0].dataIndex].fullSql);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                showFormattedSql(data[index].fullSql);
                            }
                        }
                    }
                });
            }

            function createRowsSentChart(classes) {
                var ctx = document.getElementById('rowsSentChart').getContext('2d');
                var data = classes.slice(0, 10).map(c => ({
                    fingerprint: truncateString(c.fingerprint, 30),
                    fullFingerprint: c.fingerprint,
                    avgRowsSent: parseFloat(c.metrics.Rows_sent.avg),
                    fullSql: c.example.query
                }));

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.fingerprint),
                        datasets: [{
                            label: '平均返回行数',
                            data: data.map(d => d.avgRowsSent),
                            backgroundColor: 'rgba(153, 102, 255, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '前10个查询的平均返回行数'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return data[tooltipItems[0].dataIndex].fullFingerprint;
                                    },
                                    afterBody: function (tooltipItems) {
                                        return 'SQL: ' + decodeChineseCharacters(data[tooltipItems[0].dataIndex].fullSql);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                showFormattedSql(data[index].fullSql);
                            }
                        }
                    }
                });
            }

            function createDatabaseAndTableUsageCharts(classes) {
                createDbUsageChart(classes);
                createTableUsageChart(classes);
            }

            function createDbUsageChart(classes) {
                var dbUsage = {};
                classes.forEach(c => {
                    if (c.metrics.db != undefined) {
                        var db = c.metrics.db.value;
                    }
                    dbUsage[db] = (dbUsage[db] || 0) + c.query_count;
                });

                var ctx = document.getElementById('dbUsageChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(dbUsage),
                        datasets: [{
                            data: Object.values(dbUsage),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '数据库查询次数'
                            }
                        }
                    }
                });
            }

            function createTableUsageChart(classes) {
                var tableUsage = {};
                classes.forEach(c => {
                    if (c.tables) {
                        c.tables.forEach(t => {
                            var tableName = t.create.split('`')[3];
                            tableUsage[tableName] = (tableUsage[tableName] || 0) + c.query_count;
                        });
                    }
                });

                var ctx = document.getElementById('tableUsageChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(tableUsage).slice(0, 10),
                        datasets: [{
                            label: '查询次数',
                            data: Object.values(tableUsage).slice(0, 10),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '前10个最常用表'
                            }
                        }
                    }
                });
            }

            function createQueryTimeTrendChart(classes) {
                var timeData = classes.map(c => {
                    console.log("Processing class:", c);
                    return {
                        x: new Date(c.ts_min).getTime(), // 转换为时间戳
                        y: parseFloat(c.metrics.Query_time.avg)
                    };
                }).sort((a, b) => a.x - b.x);

                var ctx = document.getElementById('queryTimeTrendChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeData.map(d => new Date(d.x).toLocaleDateString('zh-CN')),
                        datasets: [{
                            label: '平均查询时间',
                            data: timeData.map(d => d.y),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '平均查询时间（秒）'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '查询时间趋势'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (context) {
                                        return new Date(timeData[context[0].dataIndex].x).toLocaleString('zh-CN');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function createLockWaitTimeChart(classes) {
                var topLockWaitQueries = classes
                    .sort((a, b) => parseFloat(b.metrics.Lock_time.avg) - parseFloat(a.metrics.Lock_time.avg))
                    .slice(0, 10);

                var data = topLockWaitQueries.map(c => ({
                    fingerprint: truncateString(c.fingerprint, 30),
                    fullFingerprint: c.fingerprint,
                    avgLockTime: parseFloat(c.metrics.Lock_time.avg),
                    maxLockTime: parseFloat(c.metrics.Lock_time.max),
                    fullSql: c.example.query
                }));

                var ctx = document.getElementById('lockWaitTimeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.fingerprint),
                        datasets: [
                            {
                                label: '平均锁等待时间（秒）',
                                data: data.map(d => d.avgLockTime),
                                backgroundColor: 'rgba(255, 159, 64, 0.6)',
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '最长锁等待时间（秒）',
                                data: data.map(d => d.maxLockTime),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                                title: {
                                    display: true,
                                    text: '查询指纹'
                                }
                            },
                            y: {
                                stacked: false,
                                title: {
                                    display: true,
                                    text: '锁等待时间（秒）'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '前10个查询的锁等待时间'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        return data[tooltipItems[0].dataIndex].fullFingerprint;
                                    },
                                    afterBody: function (tooltipItems) {
                                        return 'SQL: ' + decodeChineseCharacters(data[tooltipItems[0].dataIndex].fullSql);
                                    }
                                }
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                showFormattedSql(data[index].fullSql);
                            }
                        }
                    }
                });
            }

            function displayAllQueries(classes) {
                var tableHtml = `
    <table id="queriesTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>查询指纹</th>
                <th>数据库</th>
                <th>平均时间(秒)</th>
                <th>最长时间(秒)</th>
                <th>执行次数</th>
                <th>最后执行时间</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
`;
                $('#allQueries').html(tableHtml);

                queriesTable = $('#queriesTable').DataTable({
                    data: classes,
                    order: [[2, 'desc']],
                    pageLength: 10,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Chinese.json'
                    },
                    columns: [
                        {
                            data: 'fingerprint',
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return `<span class="clickable-fingerprint" title="${data}" data-sql="${row.example.query}">${data}</span>`;
                                }
                                return data;
                            }
                        },
                        {
                            data: 'metrics.db.value',
                            defaultContent: 'N/A'
                        },
                        {
                            data: 'metrics.Query_time.avg',
                            render: function (data) { return parseFloat(data).toFixed(4); }
                        },
                        {
                            data: 'metrics.Query_time.max',
                            render: function (data) { return parseFloat(data).toFixed(4); }
                        },
                        { data: 'query_count' },
                        {
                            data: 'example.ts',
                            render: function (data) { return formatTimestamp(data); }
                        }
                    ],
                    columnDefs: [
                        { targets: 0, width: '30%' },
                        { targets: 1, width: '10%' },
                        { targets: [2, 3], width: '15%' },
                        { targets: 4, width: '10%' },
                        { targets: 5, width: '20%' }
                    ]
                });

                $('#queriesTable').on('click', '.clickable-fingerprint', function () {
                    showFormattedSql($(this).data('sql'));
                });

                // 填充数据库下拉菜单
                let databases = [...new Set(classes
                    .filter(item => item.metrics && item.metrics.db && item.metrics.db.value)
                    .map(item => item.metrics.db.value))];
                let dbSelect = $('#dbSelect');
                databases.forEach(db => {
                    dbSelect.append($('<option>', {
                        value: db,
                        text: db
                    }));
                });

                // 添加数据库筛选功能
                dbSelect.on('change', function () {
                    let selectedDb = $(this).val();
                    queriesTable.column(1).search(selectedDb).draw();
                });
            }

            function truncateString(str, num) {
                if (str.length <= num) {
                    return str;
                }
                return str.slice(0, num) + '...';
            }

            function decodeChineseCharacters(str) {
                const decodedStr = new TextDecoder().decode(new Uint8Array(str.split('').map(c => c.charCodeAt(0))));
                return decodedStr;
            }
            function formatTimestamp(timestamp) {
                var date = new Date(timestamp);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }

            function showFormattedSql(sql) {
                var formattedSql = sqlFormatter.format(decodeChineseCharacters(sql), {
                    language: 'mysql',
                    indent: '    '
                });

                $('#modalSqlContent').text(formattedSql);
                hljs.highlightElement(document.getElementById('modalSqlContent'));
                var modal = new bootstrap.Modal(document.getElementById('sqlModal'));
                modal.show();
            }

            function saveToLocalStorage(data, name) {
                let savedData = JSON.parse(localStorage.getItem('ptQueryDigestData')) || [];
                savedData.push({
                    timestamp: new Date().toISOString(),
                    name: name,
                    data: data
                });
                localStorage.setItem('ptQueryDigestData', JSON.stringify(savedData));
                updateHistorySelect();
            }

            function updateHistorySelect() {
                let savedData = JSON.parse(localStorage.getItem('ptQueryDigestData')) || [];
                let historySelect = $('#historySelect');
                historySelect.empty();
                historySelect.append($('<option>', {
                    value: '',
                    text: '选择历史分析记录'
                }));
                savedData.forEach((item, index) => {
                    let optionText = `${new Date(item.timestamp).toLocaleString('zh-CN')} - ${item.name}`;
                    historySelect.append($('<option>', {
                        value: index,
                        text: optionText
                    }));
                });
            }

            $('#uploadBtn').click(function () {
                var file = $('#logFile')[0].files[0];
                var analysisName = file ? file.name : '未命名分析';
                var formData = new FormData();
                formData.append('log_file', file);

                $.ajax({
                    url: '/analyze',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        visualizeData(data);
                        saveToLocalStorage(data, analysisName);
                    },
                    error: function (error) {
                        $('#results').html('<p class="text-danger">分析失败: ' + error.responseText + '</p>');
                    }
                });
            });

            $('#historySelect').change(function () {
                let selectedIndex = $(this).val();
                if (selectedIndex !== '') {
                    let savedData = JSON.parse(localStorage.getItem('ptQueryDigestData')) || [];
                    let selectedData = savedData[selectedIndex].data;
                    visualizeData(selectedData);
                }
            });

            // 初始化历史记录下拉菜单
            updateHistorySelect();
        });    
    </script>
</body>

</html>